name: Check behind against origin/dev

on:
  schedule:
    - cron: '0 9-21/3 * * *'  # ì˜¤ì „ 9ì‹œë¶€í„° ì˜¤í›„ 9ì‹œê¹Œì§€ 3ì‹œê°„ ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰
  workflow_dispatch:

jobs:
  check-remote-behind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch all remote branches
        run: git fetch --all

      - name: Compare each origin branch to origin/dev
        run: |
          DISCORD_WEBHOOK_URL="https://discord.com/api/webhooks/1371797628018495599/oG34B8I09mlhsh65sN5erjGWcJSqMStxHskgUMpNCLTFbMDznl1Of6kpJ-XO42ZLHyqs"

          TARGET_BRANCH="origin/dev"

          git for-each-ref --format='%(refname:short)' refs/remotes/origin/ | while read remote_branch; do
            # origin/dev ìì‹ ì€ ì œì™¸
            if [ "$remote_branch" = "$TARGET_BRANCH" ]; then
              continue
            fi
            if [ "$remote_branch" = "origin/main" ]; then
              continue
            fi

            # origin/dev..origin/feature ê°™ì€ ì‹ìœ¼ë¡œ ë¹„êµ (ë’¤ì²˜ì§„ ì»¤ë°‹ ìˆ˜)
            behind_count=$(git rev-list --left-right --count "$TARGET_BRANCH...$remote_branch" | awk '{print $1}')
            echo "$remote_branch is $behind_count commits behind $TARGET_BRANCH"

            if [ "$behind_count" -ge 10 ]; then
              short_branch="${remote_branch#origin/}"
              message="ğŸš¨ ë¸Œëœì¹˜ \`$short_branch\`ê°€ \`dev\`ë³´ë‹¤ $behind_count ì»¤ë°‹ ë’¤ì²˜ì ¸ ìˆìŠµë‹ˆë‹¤!"
              echo "$message"

              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\": \"$message\"}" \
                   $DISCORD_WEBHOOK_URL
            fi
          done
